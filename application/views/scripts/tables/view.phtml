<?php
$host = OpenContext_OCConfig::get_host_config();
$tableId = $this->table_id;

$tableHEADER = "";
foreach($this->table_fields as $tfield){
    if($tfield == "proj"){
        $tfield = "Project";
    }
    elseif($tfield == "person"){
        $tfield = "Linked Persons";
    }
    elseif($tfield == "label"){
        $tfield = "Item Name";
    }
    elseif($tfield == "pub_date"){
        $tfield = "Publication Date";
    }
    elseif($tfield == "update"){
        $tfield = "Last Updated";
    }
  
  if(substr_count($tfield, "def_context_")>0){
    $tfield = str_replace("def_context_", "", $tfield);
    $tfield++;
    $tfield = "Context (".$tfield.")";
  }
  
  $tableHEADER .= "<th>".$tfield."</th>".chr(13);
  //$tableHEADER .= "".$tfield."".chr(13);
}
$table_metadata=$this->table_metadata;
$table_name=$table_metadata["table_name"];

$table_name = str_replace(" Searh", " Search", $table_name);


//hack tp fox multiple
$qLink = htmlentities($table_metadata['setURI']);
if(!stristr($qLink, $host)){
    $qLink = $host.$qLink;
}
else{
    $qLink = str_replace('http://opencontext.org/createtab/setfields', $host.'/sets', $qLink);
}



$table_hash=$table_metadata["setHash"];
$numRecords = $table_metadata["numFound"];
$table_metadata["setURI"]="<a href='".$qLink."' title='Original query used to select these records'>".$qLink."</a>";
unset($table_metadata["uri"]);
unset($table_metadata["setHash"]);
unset($table_metadata["cache_id"]);


$creatorArray = array();
foreach($table_metadata["creators"] as $creator => $num){
    $creatorArray[] = $creator;
}

$projectArray = array();
foreach($table_metadata["projects"] as $project){
    $projectArray[] = $project;
}
$contribArray = array();
$contribArrayShow = array();
$jjj=0;



foreach($table_metadata["person_links"] as $subkey => $subvalue){
    
   
    $bigContributor = false;
    $contribOK = false;
    if($subvalue >= ($numRecords/4)){
        $contribOK = true;
        $bigContributor = true;
    }
    elseif((count($contribArray)<= 10)&&($subvalue >= ($numRecords * .05 ))){
        //the top 10 ranked persons on a long list of conributors, even if they contributed only 5% of the records
        $contribOK = true;
    }
    else{
        $contribOK = false;
    }
    
    $contribArray[] = $subkey;
    if($contribOK){
        $contribArrayShow[] = $subkey;
    }
    $jjj++;
}

if(count($contribArrayShow)< count($contribArray)){
    $contribArrayShow[] = (count($contribArray) - count($contribArrayShow))." Others";
}

if(array_key_exists("noid", $table_metadata)){
    $archiveID = $table_metadata["noid"];
    $table_metadata["noid"] = "ark:/".$archiveID;
    //echo var_dump($table_metadata["noid"]);
}
else{
    $archiveID = false;
}



$citation = array("contributors" => $contribArrayShow,
                  "creators" => $creatorArray,
                  "generator" => $table_metadata["TabCreator"],
                  "projects" => $projectArray,
                  "date" => date("Y", strtotime($table_metadata["TabCreated"])),
                  "title" => $table_metadata["table_name"],
                  "archive" => $archiveID,
                  "uri" => $host."/tables/".OpenContext_TableOutput::tableID_toURL($tableId));

$citationString = "<p>".implode(", ", $citation["contributors"])."</p>";
$citationString .= "<p>". $citation["date"]." &quot;".$citation["title"]."&quot; From projects: <em>".implode(", ", $citation["projects"])."</em>. ";
$citationString .= "Led by: ".implode(", ", $citation["creators"]).". Table generated by: ".$citation["generator"].". Open Context. ";
$citationString .= "&lt;".$citation["uri"]."&gt; ";
if($archiveID != false){
    $citationString .= "California Digital Library Archival Identifier, &lt;<a href='http://n2t.net/ezid/id/ark:/".$archiveID."' title='Link to current resolver for this permanent identifier'>ark:/".$archiveID."</a>&gt;";
}
$citationString .= "</p>";


if(array_key_exists("table_segments", $table_metadata)){
    $currentTab = $table_metadata["table_segments"]["currentTab"];
    $recsPerTable = $table_metadata["table_segments"]["recsPerTable"];
    $totalTab = $table_metadata["table_segments"]["totalTabs"];
    $tableMin = (($currentTab -1 ) * $recsPerTable) + 1;
    $tableMax = $currentTab * $recsPerTable;
    if($tableMax > $numRecords){
        $tableMax = $numRecords;
    }
    $table_Part_Of = "This table is part ".$currentTab." of ".$totalTab.", containing ".$tableMin." to ".$tableMax." of ".$numRecords ." total records.";
    $table_Part_Of .= "<br/>";
    
    $urlID = OpenContext_TableOutput::tableID_toURL($tableId);
    if(stristr($urlID, "/")){
        $idArray = explode("/",$urlID);
        $idPrefix = $idArray[0];
    }
    else{
        $idPrefix = $urlID;
    }
    
    if($currentTab > 1){
        $previousTabNum = $currentTab - 1;
        if($previousTabNum > 1){
            $previousTabID = "/".$previousTabNum;
        }
        else{
            $previousTabID = "";
        }
        $previousURL =  $host."/tables/".$idPrefix.$previousTabID;
        $table_Part_Of .= "<a href='$previousURL'>(Previous Part [$previousTabNum])</a>";
    }
    
    if($currentTab < $totalTab){
        $nextTabNum = $currentTab+1;
        $nextTabID = "/".$nextTabNum;
        $nextURL =  $host."/tables/".$idPrefix.$nextTabID;
        $table_Part_Of .= " <a href='$nextURL '>(Next Part [$nextTabNum])</a>";
    }
    
    unset($table_metadata["table_segments"]);
    $table_metadata["Table Notes"] = $table_Part_Of ;
    
    if($totalTab < 2){
        $table_Part_Of = false;
        unset($table_metadata["table_segments"]);
    }
    
}
else{
    $table_Part_Of = false;
}

$table_metadata["Suggested Citation"] = $citationString;

//Give most recent table links
$db_params = OpenContext_OCConfig::get_db_config();

$db = new Zend_Db_Adapter_Pdo_Mysql($db_params);
$db->getConnection();
//$db->getConnection()->setAttribute(PDO::MYSQL_ATTR_DIRECT_QUERY, false);


$sql = 'SELECT current
FROM dataset
WHERE cache_id = "'.($tableId).'"; ';


//hack!
//echo "Table ID:".$tableId;



$results = $db->fetchAll($sql, 2);
$dataCurrent = true;
if($results){
    if($results[0]['current'] == 'no'){
        $dataCurrent = false;
        $titleMessage = ' (Archived, Not Current)';
    }
    else{
        $titleMessage = '';
    }
}
else{
    $titleMessage = '';
}

$select = $db->select()
    ->from(array('t' => 'dataset'),
    array('cache_id', 'table_name', 'num_records'))
    ->where('cache_id != ?', $tableId)
    ->limit(5)
    ->order('created_on DESC');
/*  
$sql = $select->__toString();
echo "$sql\n";
*/

$stmt = $select->query();
$result = $stmt->fetchAll();
$otherTabs = "";
foreach($result as $row){
    $row['cache_id'] = OpenContext_TableOutput::tableID_toURL($row['cache_id']);
    if(strlen($row['table_name'])<1){
        $row['table_name'] = "[Not labeled, Records: ".$row['num_records']." ]";
    }
    $otherTabs .= '<li style="margin-left:0px;list-style-position:inside;"><a href="'.$host.'/tables/'.$row['cache_id'].'" title="View this data table">'.$row['table_name'].'</a></li>'.chr(13);
}
 $otherTabs .= '<li style="margin-left:0px;list-style-position:inside;"><em><a href="'.$host.'/tables/" title="View all other tables">(More)</a></em></li>'.chr(13);

$db->closeConnection();















?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
    <title>Open Context: View Table <?php echo "'$table_name'"; ?></title>
    <link rel="alternate" type="text/csv" title="<?php echo "'$table_name'"; ?> (Comma Seperated Values)" href="<?php echo $host.'/tables/'.OpenContext_TableOutput::tableID_toURL($this->table_id).'.csv';?>"/>
    <link rel="alternate" type="application/json" title="<?php echo "'$table_name'"; ?> (JSON)" href="<?php echo $host.'/tables/'.OpenContext_TableOutput::tableID_toURL($this->table_id).'.json';?>"/>
    <?php
    if($archiveID != false){
        echo '<link rel="archival" type="application/xhtml+xml" href="http://n2t.net/ezid/id/ark:/'.$archiveID.'"/>'.chr(13);
    }
    ?>
    <link href="/css/opencontext_style.css" rel="stylesheet" type="text/css" /> 
    <link href="/css/test_landing_page.css" rel="stylesheet" type="text/css" />
    <link href="/css/default_banner.css" rel="stylesheet" type="text/css" />
    <link href="/css/rounded_corners.css" rel="stylesheet" type="text/css" />
    
    <link rel="shortcut icon" href="/images/general/oc_favicon.ico" type="image/x-icon" />
  </head>
    
  <body>
    <div id="oc_logo"><a href="<?php echo $host; ?>"><img alt="Open Context Logo" src="/images/general/oc_logo.jpg" border="0" ></img></a></div>
    <div id="oc_tagline">	<img alt="Open Context Tagline" src="/images/general/oc_tagline.jpg" ></img></div>
    <div id="oc_beta"><img alt="Beta Stamp" src="/images/general/oc_betastamp.jpg" ></img></div>
    <div id="oc_top_search">

	<form method="get" action="../sets/" id="search-form">
	<div id="search_box">
	<input type='text' name='q' class='tinyText' value='Search' size='30' onfocus="if(this.value=='Search')this.value='';" onblur="if(this.value=='')this.value='Search';" />
	</div>
	<div id="search_cntrl">
	    <input class="oc_top_sbutton" type="submit" value="" />
	</div>
	</form>
    </div>
    <!-- 
    Navigation tabs
    -->    
    <?php echo OpenContext_NavMenus::GeneralNavMenu("tables"); ?>
    
    <div id="main" style="width:900px;overflow:hidden;">
      <!-- BREADCRUMB 
      <div class="breadcrumb">
        <a href="<?php echo $host.'/tables'?>">All Tables</a>
      </div>
      -->
      <!-- LEFT HAND COLUMN-->
      <div id="table_left_page" style="width:94%;">
        <div class="metadata">
          
            <div>  
                <div style="width: 60%; float:left;">  
                    <p class="heading" style="font-weight:bold;padding:0px;margin:9px 0px 2px 0px;">Table: &ldquo;<?php echo $table_name; ?>&rdquo; <?php echo $titleMessage; ?></p>
                    <p class="bodyText">
                      <strong>Note: </strong>
                      
                      <?php
                      
                      //echo "Part ID: ".$this->partID."<br/>";
                      
                      if(count($projectArray)<2){
                          echo "The data in this table comes from one project or collection. Some data relating to the records in this table may depend upon
                          complex structures that cannot be easily represented in a table format. If you need data fully expressing such complex structures, download
                          the XML representations of these data. To learn how to do this, please read the <a href='".$host."/about/services/'
                          title='Methods for retrieving machine-readable data'>web-services documentation</a>.";
                      }
                      else{
                          echo "This table contains data originating from different projects and collections. These different projects may have worked under different
                      assumptions and methodologies which may complicate comparisons. This may be the case even if projects and collections
                      used the same descriptive terminology. In working with these data, you should exercise your best
                      critical judgment as a researcher and examine available dataset documentation and related publications to help
                      inform your interpretations.";
                      }
                    
                      ?>
                    </p>
                    
                    <p class="download_option">Download this table: <a href="<?php echo $host.'/tables/'.OpenContext_TableOutput::tableID_toURL($this->table_id).'.csv';?>">CSV format</a></p>
                    <!--
                    <p>Google Link :<?php echo $this->google_link;?></p>
                    -->
                    <?php
                    if(!$dataCurrent){ 
                        echo '<p class="bodyText"><em><strong>Note: </strong>Open Context has been updated since this table was created.
                        For reference purposes, Open Context has archived the data in this table as originally created. You can download
                        the archived data by following the link labled "CSV fomat" above. Or click the "Query Link" below
                        to re-run the original query that generated this table and get more current data.</em> 
                        </p>';
                    }
                    ?>
                    
                    
                </div>
                <div style="width: 30%; float:right; margin-top:15px;">
                    <div id="panel" class="rounded-corners">
                        <div class="panel_heading">Recently created tables:</div>
                        <div class="panel_content">
                          <ul style="margin:0px;padding:0px">
                            <?php echo $otherTabs; ?>
                          </ul>
                        </div>
                    </div>
                </div>
                <div style="width:90%; clear:both;" ></div>
            </div>
          
          
          <!--<p class="description"></p>-->
          <table cellpadding="0px" cellspacing="0px">
            <?php
            $iii = 0;
            $bigContributor = false;
            foreach($table_metadata as $field=>$value){  
                echo '<tr style="background-color:';
                
                if($iii&1){
                    echo "#fffdbe";
                }
                else{
                    echo "#FFFFFF";
                }
                echo '">';
                $iii++;
                
                $proj = false;
                switch($field){
                    case "setURI":
                        $field = "Query Link";
                        break;
                    case "numFound":
                        $field = "Number of Records";
                        break;
                    case "person_links":
                        $field = "Principal Analyst(s) / Observers";
                        break;
                    case "creators":
                        $field = "Directing / Supervisory People";
                        break;
                    case "projects":
                        $field = "Projects and Collections";
                        $proj = true;
                        break;
                    case "TabCreated":
                        $field = "Time of Table Creation";
                        break;
                    case "TabCreator":
                        $field = "Table Generated by";
                        break;
                    case "table_name":
                        $field = "Table Name";
                        break;
                    case "table_description":
                        $field = "Table Description";
                        break;
                    case "tagstring":
                        $field = "Tags / Keywords";
                        break;
                    case "noid":
                        $field = "CDL Archival Identifier";
                        break;
                    case "setLastPublished":
                        $field = "Latest Publication Date of Items in Table";
                        $value = date("F j, Y, g:i a", strtotime($value));
                        break;
                    case "setLastUpdate":
                        $field = "Latest Update / Revision Time of Items in Table";
                         $value = date("F j, Y, g:i a", strtotime($value));
                        break;
                }
                
                echo '<td style="vertical-align:middle;">'.$field.'</td>';
                echo '<td style="padding-left:10px; ">';
                if(is_array($value)){
                    $jjj=0;
                    $cellValues = "";
                    foreach($value as $subkey=>$subvalue){
                        
                        if(!$proj){
                            $print_value = $subkey;
                        }
                        else{
                            $print_value = $subvalue;
                        }
                            
                        if($jjj!=0){
                            $print_value = ", ".$print_value;
                        }
                        
                        if($field == "Table Name"){
                            $print_value = $table_name;
                        }
                        
                        if($field == "Contributors"){
                            
                            $contribOK = false;
                            if($subvalue >= ($numRecords/4)){
                                //if the person contributed 25% or more records, they should be in citation
                                $contribArray[] = $subkey;
                                $contribOK = true;
                                $bigContributor = true;
                            }
                            elseif((count($contribArray)<= $jjj)&&($jjj < 10)&&(!$bigContributor)&&($subvalue >= ($numRecords * .05 ))){
                                //the top 10 ranked persons on a long list of conributors, even if they contributed only 5% of the records
                                $contribArray[] = $subkey;
                                $contribOK = true;
                            }
                            else{
                                $contribOK = false;
                            }
                            
                            if($contribOK){
                                
                            }
                            else{
                                $print_value = ""; // this person is not a valid contributor for citation
                            }
                        
                            
                        }
                        
                        $cellValues .= $print_value;
                        $jjj++;
                    }
                    
                    
                    echo $cellValues;
                }
                else{
                    echo $value;
                }
                echo '</td>';
                echo '</tr>';
                
                if(($field == "Number of Records") && $table_Part_Of != false){
                   //echo '<tr><td>Part Information</td><td>'.$table_Part_Of.'</td></tr>';
                }
                
            }
        
            
            ?>
          </table>
        </div>
        <!-- pagination -->
        <?php echo $this->paginationControl($this->table_data, 'Sliding', 'tables/pagination_control.phtml',array('host'=>$host,'hash'=>$table_hash)); ?>
        <div class="table_data" style="border:2px solid #dddddd;overflow:auto;">
          <table cellpadding="0px" cellspacing="0px">
            <thead><tr><?php echo $tableHEADER ?></tr></thead>
            <tbody>
            <?php
            $iii=0;
            foreach($this->table_data as $actUUID => $actRecord){
                echo '<tr style="background-color:';
                
                if($iii&1){
                    echo "#fffdbe";
                }
                else{
                    echo "#FFFFFF";
                }
                echo '">';
                $iii++;
                
                foreach($actRecord as $field=>$value){
                    echo '<td>';
                    if ($field == 'label'){
                        echo '<a href="'.$host.'/subjects/'.$actUUID.'">'.$value.'</a>';
                    }
                    else{
                        echo $value;
                    }
                    echo '</td>';
                }
                echo '</tr>';
            }
            ?>
            </tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT HAND COLUMN 
      <div id ="table_right_page" style="width:20%">
        <div id="panel">
          <div class="panel_heading">Recently created tables:</div>
          <div class="panel_content">
            <ul style="margin:0px;padding:0px">
              <?php echo $otherTabs; ?>
            </ul>
          </div>
        </div>
        
         
        <div id="panel">
          <div class="panel_heading">Help:</div>
          <div class="panel_content">
            <ul style="margin:0px;padding:0px">
              <li style="margin-left:0px;list-style-position:inside;"><a href="../tables/help#download" title="Coming soon">How do I download data?</a></li>
              <li style="margin-left:0px;list-style-position:inside;"><a href="../tables/help#formats" title="Coming soon">What data formats available?</a></li>
              <li style="margin-left:0px;list-style-position:inside;"><a href="../tables/help#uses" title="Coming soon">How can I use this data?</a></li>
            </ul>
          </div>
        </div>
         
        
      </div>
      
      -->
      
      
    </div>
  </body>
</html>
